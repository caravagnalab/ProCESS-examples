---
title: "SPN02"
author: "Virginia Gazziero"
date: "`r Sys.Date()`"
output:
  pdf_document: default
  html_document: default
---

```{r setup}
knitr::opts_chunk$set(echo = TRUE)
library(rRACES)
library(tidyverse)
```

```{r, fig.align='center', fig.cap="SPN02", echo = F}
knitr::include_graphics(path = "../../rRACES/vignettes/img/SCOUT/SPN02.png")
```

## Tissue generation

Initialize the simulation with one clone

```{r}
seed <- 1679
set.seed(seed)
dt <- .1

sim = new(Simulation, 
          seed = seed,
          save_snapshot = T)
sim$update_tissue(1e3, 1e3)
sim$duplicate_internal_cells <- TRUE
sim$death_activation_level <- 50

# adding first clone

sim$add_mutant(name = "Clone 1", 
               growth_rates = 0.5,
               death_rates = 0.01)
sim$place_cell("Clone 1", 500, 500)
sim$run_up_to_size("Clone 1", 1500)
```

```{r, warning=FALSE}
plot_tissue(sim)
```

Add the second clone, while the first one starts dying.

```{r}
sim$add_mutant(name = "Clone 2",
               growth_rates = 1,
               death_rates = 0.01)

sim$mutate_progeny(sim$choose_cell_in("Clone 1"), "Clone 2")
sim$update_rates("Clone 1", rates = c(growth = 0, death = 0.2))
sim$run_up_to_size("Clone 2", 3000)
```

```{r, warning=FALSE}
plot_muller(sim)
plot_tissue(sim)
```

Add last clone.

```{r}
sim$add_mutant(name = "Clone 3",
               growth_rates = 5,
               death_rates = 0.01)

sim$mutate_progeny(sim$choose_cell_in("Clone 2"), "Clone 3")

sim$update_rates("Clone 2", rates = c(growth = 0, death = 0.5))
sim$run_up_to_size("Clone 3", 8000)
```

```{r, warning=FALSE}
plot_muller(sim)
plot_tissue(sim)
```

## Sampling and phylogeny

Two sampling have been performed at the same time point.

```{r, warning=FALSE}

box_w = 20 
box1_p <- c(460, 420)
box1_q = box1_p + box_w

box2_p <- c(520, 430)
box2_q = box2_p + box_w

plot_tissue(sim) +
  geom_rect(xmin = box1_p[1], xmax = box1_q[1], 
            ymin = box1_p[2], ymax = box1_q[2], 
            fill = NA, color = "black") +
  geom_rect(xmin = box2_p[1], xmax = box2_q[1], 
            ymin = box2_p[2], ymax = box2_q[2], 
            fill = NA, color = "black") 

sim$sample_cells("A", box1_p, box1_q)
sim$sample_cells("B", box2_p, box2_q)
```

```{r}
sampled_phylogeny <- sim$get_samples_forest()

plot_forest(sampled_phylogeny) %>%
  annotate_forest(sampled_phylogeny, 
                  samples = TRUE, 
                  MRCAs = TRUE, 
                  exposures = FALSE, 
                  facet_signatures = FALSE, 
                  drivers = FALSE, 
                  add_driver_label = FALSE) + 
  ylim(0,5)
```

## Adding mutations

```{r}
# m_engine <- build_mutation_engine(setup_code = "GRCh38")
```

-   Clone 1: BRAF V600E

```{r}
# m_engine$add_mutant(mutant_name = "Clone 1",
#                     passenger_rates = c(SNV = 3e-8, CNA = 1e-11),
#                     driver_SNVs = SNV("7", 10510210, "A")) 
```
